<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글</title>
    <style>
        @font-face {
            font-family: 'GounBatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/GowunBatang-Regular.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'GounBatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/GowunBatang-Bold.woff') format('woff');
            font-weight: 700;
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'GounBatang', serif;
            background: #fefefe;
            color: #222;
            line-height: 1.8;
            font-size: 18px;
            overflow-x: hidden;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 60px 40px;
            min-height: 100vh;
        }

        header {
            margin-bottom: 80px;
            text-align: center;
            opacity: 0;
            animation: fadeIn 1.5s ease forwards;
        }

        h1 {
            font-size: 28px;
            font-weight: normal;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .subtitle {
            font-size: 14px;
            color: #666;
            letter-spacing: 1px;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 60px;
            opacity: 0;
            animation: fadeIn 2s ease 0.3s forwards;
        }

        .nav button {
            background: none;
            border: none;
            font-family: 'GounBatang', serif;
            font-size: 16px;
            color: #999;
            cursor: pointer;
            padding: 10px 0;
            letter-spacing: 1px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .nav button.active {
            color: #222;
            border-bottom-color: #222;
        }

        .nav button:hover {
            color: #222;
        }

        .section {
            display: none;
            opacity: 0;
            animation: fadeIn 0.8s ease forwards;
        }

        .section.active {
            display: block;
        }

        /* 글쓰기 섹션 */
        .writing-area {
            position: relative;
            margin-bottom: 40px;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            border: none;
            outline: none;
            background: transparent;
            font-family: 'GounBatang', serif;
            font-size: 18px;
            line-height: 1.8;
            color: #222;
            resize: none;
            padding: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        textarea::placeholder {
            color: #bbb;
            font-style: italic;
        }

        .title-input {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-family: 'GounBatang', serif;
            font-size: 22px;
            font-weight: 700;
            color: #222;
            margin-bottom: 20px;
            padding: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .title-input::placeholder {
            color: #bbb;
            font-weight: normal;
        }

        .write-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .write-actions button {
            background: none;
            border: 1px solid #ddd;
            padding: 10px 20px;
            font-family: 'GounBatang', serif;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s ease;
            position: relative;
        }

        .write-actions button:hover {
            background: #222;
            color: #fff;
            border-color: #222;
        }

        .write-actions button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .write-actions button:disabled:hover {
            background: none;
            color: #666;
            border-color: #ddd;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ddd;
            border-top: 2px solid #666;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        /* 읽기 섹션 */
        .posts-container {
            min-height: 400px;
        }

        .post {
            margin-bottom: 60px;
            padding-bottom: 40px;
            border-bottom: 1px solid #f0f0f0;
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.6s ease forwards;
        }

        .post:last-child {
            border-bottom: none;
        }

        .post-title {
            font-size: 22px;
            font-weight: 700;
            color: #222;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .post-meta {
            font-size: 12px;
            color: #999;
            margin-bottom: 25px;
            letter-spacing: 0.5px;
        }

        .post-content {
            font-size: 18px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .empty-message {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 80px 0;
        }

        .load-more {
            text-align: center;
            margin-top: 40px;
        }

        .load-more button {
            background: none;
            border: 1px solid #ddd;
            padding: 12px 24px;
            font-family: 'GounBatang', serif;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s ease;
        }

        .load-more button:hover {
            background: #f8f8f8;
            border-color: #ccc;
        }

        .load-more button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #fcc;
            text-align: center;
            font-size: 14px;
        }

        .success-message {
            background: #efe;
            color: #363;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #cfc;
            text-align: center;
            font-size: 14px;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            .container {
                padding: 40px 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .nav {
                gap: 30px;
            }
            
            textarea, .title-input {
                font-size: 16px;
            }
            
            .post-title {
                font-size: 20px;
            }
            
            .post-content {
                font-size: 16px;
            }
            
            .write-actions {
                flex-direction: column;
                gap: 15px;
            }
        }

        html {
            scroll-behavior: smooth;
        }

        ::selection {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>글</h1>
            <p class="subtitle">생각을 나누는 공간</p>
        </header>

        <nav class="nav">
            <button class="nav-btn active" data-section="write">쓰기</button>
            <button class="nav-btn" data-section="read">읽기</button>
        </nav>

        <!-- 글쓰기 섹션 -->
        <section id="write" class="section active">
            <div id="writeMessage"></div>
            <div class="writing-area">
                <input type="text" class="title-input" id="titleInput" placeholder="제목을 입력하세요" maxlength="100">
                <textarea id="contentInput" placeholder="당신의 생각을 적어보세요..."></textarea>
            </div>
            
            <div class="write-actions">
                <button onclick="clearPost()" id="clearBtn">지우기</button>
                <button onclick="submitPost()" id="submitBtn">올리기</button>
            </div>
        </section>

        <!-- 읽기 섹션 -->
        <section id="read" class="section">
            <div id="readMessage"></div>
            <div class="posts-container" id="postsContainer">
                <div class="empty-message">글을 불러오는 중...</div>
            </div>
            <div class="load-more" id="loadMore" style="display: none;">
                <button onclick="loadMorePosts()" id="loadMoreBtn">더 보기</button>
            </div>
        </section>
    </div>

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    
    <script>
        // ⚠️ 실제 배포 시에는 환경변수를 사용하세요!
        // 아래 값들을 본인의 Supabase 프로젝트 정보로 변경해주세요
        const SUPABASE_URL = 'https://qvoykdovekvbkdwkyigb.supabase.co'; // 예: https://xxxxxxxxxxx.supabase.co
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2b3lrZG92ZWt2Ymtkd2t5aWdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjQyOTYsImV4cCI6MjA3NDMwMDI5Nn0.vaRaGRWQOl1JheF2RLP5d_5zVweKDJOAdaXkYwngi98';
        
        // Supabase 클라이언트 초기화
        let supabase;
        
        // Supabase 로드 대기
        function initSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase 라이브러리가 로드되지 않았습니다.');
                }
                
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY || 
                    SUPABASE_URL === 'YOUR_SUPABASE_URL' || 
                    SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                    throw new Error('Supabase 설정이 필요합니다.');
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return true;
            } catch (error) {
                console.error('Supabase 초기화 실패:', error);
                showError('데이터베이스 연결에 실패했습니다. 설정을 확인해주세요.');
                return false;
            }
        }

        let currentPage = 0;
        const postsPerPage = 10;
        let isLoading = false;

        // 네비게이션
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetSection = btn.dataset.section;
                switchSection(targetSection);
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        function switchSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');
            
            if (sectionName === 'read') {
                loadPosts();
            }
        }

        async function submitPost() {
            const title = document.getElementById('titleInput').value.trim();
            const content = document.getElementById('contentInput').value.trim();
            
            if (!title || !content) {
                showError('제목과 내용을 모두 입력해주세요.');
                return;
            }
            
            if (title.length > 100) {
                showError('제목은 100자 이내로 작성해주세요.');
                return;
            }
            
            if (content.length > 5000) {
                showError('내용은 5000자 이내로 작성해주세요.');
                return;
            }

            setSubmitLoading(true);
            clearMessage('write');

            try {
                const { data, error } = await supabase
                    .from('posts')
                    .insert([
                        {
                            title: title,
                            content: content
                        }
                    ]);

                if (error) throw error;

                // 입력 필드 초기화
                document.getElementById('titleInput').value = '';
                document.getElementById('contentInput').value = '';
                
                showSuccess('글이 성공적으로 등록되었습니다!');
                
                // 1초 후 읽기 섹션으로 이동
                setTimeout(() => {
                    switchSection('read');
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-section="read"]').classList.add('active');
                    currentPage = 0; // 페이지 리셋
                }, 1000);

            } catch (error) {
                console.error('글 작성 중 오류:', error);
                showError('글 작성 중 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                setSubmitLoading(false);
            }
        }

        function clearPost() {
            if (confirm('작성 중인 내용을 지우시겠습니까?')) {
                document.getElementById('titleInput').value = '';
                document.getElementById('contentInput').value = '';
                document.getElementById('titleInput').focus();
                clearMessage('write');
            }
        }

        async function loadPosts(reset = false) {
            if (isLoading) return;
            
            if (reset) {
                currentPage = 0;
                document.getElementById('postsContainer').innerHTML = '<div class="empty-message">글을 불러오는 중...</div>';
            }

            isLoading = true;
            setLoadMoreLoading(true);
            clearMessage('read');

            try {
                const from = currentPage * postsPerPage;
                const to = from + postsPerPage - 1;

                const { data: posts, error, count } = await supabase
                    .from('posts')
                    .select('*', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range(from, to);

                if (error) throw error;

                const container = document.getElementById('postsContainer');
                const loadMoreBtn = document.getElementById('loadMore');

                if (posts.length === 0 && currentPage === 0) {
                    container.innerHTML = '<div class="empty-message">아직 글이 없습니다. 첫 번째 글을 써보세요.</div>';
                    loadMoreBtn.style.display = 'none';
                    return;
                }

                if (reset || currentPage === 0) {
                    container.innerHTML = '';
                }

                posts.forEach((post, index) => {
                    const postElement = document.createElement('div');
                    postElement.className = 'post';
                    postElement.style.animationDelay = `${index * 0.1}s`;
                    
                    const createdAt = new Date(post.created_at).toLocaleString('ko-KR');
                    
                    postElement.innerHTML = `
                        <h2 class="post-title">${escapeHtml(post.title)}</h2>
                        <div class="post-meta">${createdAt}</div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                    `;
                    
                    container.appendChild(postElement);
                });

                // 더 보기 버튼 표시/숨김
                const totalLoaded = (currentPage + 1) * postsPerPage;
                if (totalLoaded < count) {
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }

            } catch (error) {
                console.error('글 로드 중 오류:', error);
                showError('글을 불러오는 중 오류가 발생했습니다.', 'read');
                
                if (currentPage === 0) {
                    document.getElementById('postsContainer').innerHTML = '<div class="empty-message">글을 불러오지 못했습니다.</div>';
                }
            } finally {
                isLoading = false;
                setLoadMoreLoading(false);
            }
        }

        async function loadMorePosts() {
            currentPage++;
            await loadPosts();
        }

        function setSubmitLoading(loading) {
            const submitBtn = document.getElementById('submitBtn');
            const clearBtn = document.getElementById('clearBtn');
            
            if (loading) {
                submitBtn.innerHTML = '<span class="loading"></span>올리는 중...';
                submitBtn.disabled = true;
                clearBtn.disabled = true;
            } else {
                submitBtn.innerHTML = '올리기';
                submitBtn.disabled = false;
                clearBtn.disabled = false;
            }
        }

        function setLoadMoreLoading(loading) {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            if (loading && loadMoreBtn) {
                loadMoreBtn.innerHTML = '<span class="loading"></span>불러오는 중...';
                loadMoreBtn.disabled = true;
            } else if (loadMoreBtn) {
                loadMoreBtn.innerHTML = '더 보기';
                loadMoreBtn.disabled = false;
            }
        }

        function showError(message, section = 'write') {
            const messageDiv = document.getElementById(section + 'Message');
            messageDiv.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function showSuccess(message, section = 'write') {
            const messageDiv = document.getElementById(section + 'Message');
            messageDiv.innerHTML = `<div class="success-message">${message}</div>`;
        }

        function clearMessage(section) {
            const messageDiv = document.getElementById(section + 'Message');
            messageDiv.innerHTML = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', () => {
            // Supabase 초기화를 약간 지연시켜 라이브러리 로드 완료 대기
            setTimeout(() => {
                if (initSupabase()) {
                    loadPosts(true);
                } else {
                    document.getElementById('postsContainer').innerHTML = 
                        '<div class="empty-message">데이터베이스 연결에 실패했습니다.<br>Supabase 설정을 확인해주세요.</div>';
                }
            }, 100);
        });

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (document.getElementById('write').classList.contains('active')) {
                        submitPost();
                    }
                }
            }
        });

        // 텍스트 영역 자동 높이 조절
        document.getElementById('contentInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.max(300, this.scrollHeight) + 'px';
        });
    </script>
</body>
</html>